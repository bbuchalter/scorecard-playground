<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Company Scorecards</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="cache-version.js?v=1.0.4"></script>
  <script src="team-navigation.js?v=1.0.4"></script>
  <script src="scorecard-config.js?v=1.0.4"></script>
  <script src="scorecard-compute.js?v=1.0.4"></script>
  <script src="mock-data.js?v=1.0.4"></script>
  <script src="org-tree.js?v=1.0.4"></script>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111935;
      --panel2: #0f1730;
      --text: #e9eefc;
      --muted: #a9b4d6;
      --border: rgba(255,255,255,.10);
      --excellent: #6ee7b7;
      --good: #5eead4;
      --fair: #fde68a;
      --at-risk: #fb923c;
      --critical: #fb7185;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 10% 10%, rgba(147,197,253,.14), transparent),
                  radial-gradient(1000px 600px at 90% 20%, rgba(110,231,183,.10), transparent),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 12px 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .header-left {
      flex: 1;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      padding-top: 2px;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 22px;
      font-weight: 700;
      color: var(--muted);
    }

    .breadcrumb-link {
      color: var(--text);
      text-decoration: none;
      transition: color 0.2s;
      font-weight: 600;
    }

    .breadcrumb-link:hover {
      color: var(--excellent);
    }

    .breadcrumb-separator {
      color: var(--muted);
      font-weight: 300;
    }

    .breadcrumb-current {
      color: var(--text);
      font-weight: 600;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .nav-btn:hover {
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.20);
      transform: translateY(-1px);
    }

    .view-selector {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 16px;
      color: var(--text);
      font-size: 14px;
      font-family: var(--sans);
      cursor: pointer;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding: 16px 20px;
      background: rgba(255,255,255,.03);
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 13px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .legend-dot.excellent { background: var(--excellent); }
    .legend-dot.good { background: var(--good); }
    .legend-dot.fair { background: var(--fair); }
    .legend-dot.at-risk { background: var(--at-risk); }
    .legend-dot.critical { background: var(--critical); }

    .legend-trend {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 20px;
    }

    .legend-trend svg {
      width: 30px;
      height: 16px;
    }

    .scorecard-table {
      width: 100%;
      background: var(--panel);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,.3);
    }

    .scorecard-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .scorecard-table thead {
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid var(--border);
    }

    .scorecard-table th {
      padding: 16px 20px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .scorecard-table th:first-child {
      width: 200px;
      text-align: center;
    }

    .scorecard-table th:not(:first-child) {
      text-align: center;
    }

    .scorecard-table tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .scorecard-table tbody tr.clickable {
      cursor: pointer;
    }

    .scorecard-table tbody tr:nth-child(even) {
      background: rgba(255,255,255,.02);
    }

    .scorecard-table tbody tr.clickable:hover {
      background: rgba(255,255,255,.08);
    }

    .scorecard-table tbody tr:last-child {
      border-bottom: none;
    }

    .scorecard-table td {
      padding: 20px;
    }

    .group-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .drill-down-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 14px;
    }

    .clickable .drill-down-icon {
      color: var(--excellent);
    }

    .metric-cell {
      text-align: center;
    }

    .metric-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .score-badge {
      font-size: 20px;
      font-weight: 700;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: -0.5px;
    }

    .grade-badge {
      font-size: 32px;
      font-weight: 800;
      width: 64px;
      height: 64px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: -0.5px;
    }

    .score-badge.excellent,
    .grade-badge.excellent {
      background: rgba(110,231,183,.18);
      color: var(--excellent);
      border: 1px solid rgba(110,231,183,.3);
    }

    .score-badge.good,
    .grade-badge.good {
      background: rgba(94,234,212,.18);
      color: var(--good);
      border: 1px solid rgba(94,234,212,.3);
    }

    .score-badge.fair,
    .grade-badge.fair {
      background: rgba(253,230,138,.18);
      color: var(--fair);
      border: 1px solid rgba(253,230,138,.3);
    }

    .score-badge.at-risk,
    .grade-badge.at-risk {
      background: rgba(251,146,60,.18);
      color: var(--at-risk);
      border: 1px solid rgba(251,146,60,.3);
    }

    .score-badge.critical,
    .grade-badge.critical {
      background: rgba(251,113,133,.18);
      color: var(--critical);
      border: 1px solid rgba(251,113,133,.3);
    }

    .sparkline-container {
      width: 100px;
      height: 32px;
      position: relative;
    }

    .current-avg {
      text-align: center;
      padding: 20px;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .current-avg-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .current-avg-value {
      font-size: 24px;
      font-weight: 700;
    }

    .current-avg-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }


    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .hero-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .hero-section {
        grid-template-columns: 1fr;
      }
    }

    .hero-grade {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      border: 1px solid var(--border);
      position: relative;
    }

    .hero-grade-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 12px;
    }

    .ownership-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .ownership-row {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .ownership-role {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(169, 180, 214, 0.7);
    }

    .ownership-name {
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ownership-name-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .owner-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      flex-shrink: 0;
      object-fit: cover;
    }

    .hero-grade-badge {
      font-size: 80px;
      font-weight: 900;
      width: 160px;
      height: 160px;
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      letter-spacing: -2px;
      margin-bottom: 16px;
    }

    .hero-grade-score {
      font-size: 32px;
      font-weight: 700;
      color: var(--text);
      font-family: var(--mono);
    }

    .hero-sparkline-container {
      width: 200px;
      height: 60px;
      position: relative;
      margin-top: 12px;
    }

    .hero-grade-badge.excellent {
      background: rgba(110,231,183,.18);
      color: var(--excellent);
      border: 2px solid rgba(110,231,183,.4);
    }

    .hero-grade-badge.good {
      background: rgba(94,234,212,.18);
      color: var(--good);
      border: 2px solid rgba(94,234,212,.4);
    }

    .hero-grade-badge.fair {
      background: rgba(253,230,138,.18);
      color: var(--fair);
      border: 2px solid rgba(253,230,138,.4);
    }

    .hero-grade-badge.at-risk {
      background: rgba(251,146,60,.18);
      color: var(--at-risk);
      border: 2px solid rgba(251,146,60,.4);
    }

    .hero-grade-badge.critical {
      background: rgba(251,113,133,.18);
      color: var(--critical);
      border: 2px solid rgba(251,113,133,.4);
    }

    .priority-work-panel {
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .priority-work-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--muted);
      margin: 0 0 14px;
    }

    .priority-work-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      overflow-y: auto;
      max-height: 500px;
    }

    .priority-item {
      display: block;
      text-decoration: none;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      transition: background .15s, border-color .15s;
    }

    .priority-item:hover {
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
    }

    .priority-item-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .priority-item-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .priority-item-category {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .6px;
      color: var(--muted);
    }

    .priority-item-opportunity {
      margin-left: auto;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 700;
      color: var(--good);
    }

    .priority-item-name {
      font-size: 12px;
      color: var(--text);
      line-height: 1.4;
      padding-left: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .priority-item-team {
      font-size: 10px;
      color: var(--muted);
      padding-left: 12px;
      margin-top: 2px;
    }

    .priority-empty {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      padding: 16px 0;
    }

    .hero-section-wrapper {
      margin-bottom: 30px;
    }

    .data-editor-link {
      display: inline-block;
      text-align: center;
      padding: 6px 10px;
      background: rgba(147,197,253,.12);
      border: 1px solid rgba(147,197,253,.24);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      text-decoration: none;
      transition: background .15s, border-color .15s;
    }

    .data-editor-link:hover {
      background: rgba(147,197,253,.20);
      border-color: rgba(147,197,253,.40);
    }

    .trend-chart-container {
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 24px;
      margin-bottom: 30px;
    }

    .trend-chart-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .trend-chart-canvas {
      height: 250px;
    }

    /* Sub-team page layout: hero-grade + metrics trend stacked on left */
    .hero-section-subteam {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .hero-section-subteam {
        grid-template-columns: 1fr;
      }
    }

    .hero-left-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .hero-top-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 20px;
    }

    .hero-grade-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (max-width: 600px) {
      .hero-top-row {
        grid-template-columns: 1fr;
      }
    }

    .hero-grade-compact {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      border: 1px solid var(--border);
      flex: 1;
    }

    .hero-ownership-panel {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 16px;
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .hero-ownership-panel .ownership-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .hero-metrics-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 20px;
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .hero-grade-compact .hero-grade-badge {
      font-size: 48px;
      width: 90px;
      height: 90px;
      border-radius: 16px;
      margin-bottom: 8px;
    }

    .hero-grade-compact .hero-grade-score {
      font-size: 22px;
    }

    .hero-grade-compact .hero-sparkline-container {
      width: 140px;
      height: 40px;
      margin-top: 8px;
    }

    .hero-metrics-bars {
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-width: 180px;
    }

    .metric-bar-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-bar-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metric-bar-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .metric-bar-dot.slos { background: #93c5fd; }
    .metric-bar-dot.vulns { background: #fb7185; }
    .metric-bar-dot.bugs { background: #fde68a; }
    .metric-bar-dot.postmortems { background: #c4b5fd; }

    .metric-bar-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }

    .metric-bar-pct {
      font-family: ui-monospace, monospace;
      font-size: 13px;
      font-weight: 600;
    }

    .metric-bar-pct.excellent { color: var(--excellent); }
    .metric-bar-pct.good { color: var(--good); }
    .metric-bar-pct.fair { color: var(--fair); }
    .metric-bar-pct.at-risk { color: var(--at-risk); }
    .metric-bar-pct.critical { color: var(--critical); }

    .metric-bar-score {
      font-family: ui-monospace, monospace;
      font-size: 12px;
      color: var(--muted);
      padding-left: 16px;
      margin-bottom: 4px;
    }

    .metric-bar-track {
      height: 6px;
      border-radius: 3px;
      background: rgba(255,255,255,.08);
      overflow: hidden;
      margin-left: 16px;
    }

    .metric-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width .3s ease;
    }

    .metric-bar-fill.excellent { background: var(--excellent); }
    .metric-bar-fill.good { background: var(--good); }
    .metric-bar-fill.fair { background: var(--fair); }
    .metric-bar-fill.at-risk { background: var(--at-risk); }
    .metric-bar-fill.critical { background: var(--critical); }

    /* Grade tooltip */
    .grade-tooltip-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .grade-info-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
      cursor: help;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .grade-info-icon:hover {
      background: rgba(255,255,255,.25);
      border-color: rgba(255,255,255,.4);
      color: var(--text);
    }

    .grade-tooltip {
      position: absolute;
      bottom: calc(100% + 12px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(17, 25, 53, 0.98);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 10px;
      padding: 14px 16px;
      width: 200px;
      box-shadow: 0 8px 32px rgba(0,0,0,.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 1000;
    }

    .grade-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: rgba(17, 25, 53, 0.98);
    }

    .grade-tooltip-wrapper:hover .grade-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .grade-tooltip-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 10px;
      text-align: center;
    }

    .grade-tooltip-scale {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .grade-tooltip-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }

    .grade-tooltip-letter {
      font-weight: 700;
      width: 20px;
      text-align: center;
    }

    .grade-tooltip-letter.grade-a { color: var(--excellent); }
    .grade-tooltip-letter.grade-b { color: var(--good); }
    .grade-tooltip-letter.grade-c { color: var(--fair); }
    .grade-tooltip-letter.grade-d { color: var(--at-risk); }
    .grade-tooltip-letter.grade-f { color: var(--critical); }

    .grade-tooltip-range {
      color: var(--muted);
      font-family: ui-monospace, monospace;
      font-size: 11px;
    }

    .trend-chart-inline {
      flex: 1;
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .trend-chart-inline .trend-chart-title {
      font-size: 11px;
      margin-bottom: 10px;
    }

    .trend-chart-inline .trend-chart-canvas {
      flex: 1;
      min-height: 120px;
    }

    /* Failing teams sub-row in table */
    .failing-teams-row {
      background: rgba(251, 113, 133, 0.04) !important;
    }

    .failing-teams-row:hover {
      background: rgba(251, 113, 133, 0.08) !important;
    }

    .failing-teams-row td {
      padding: 10px 20px 10px 120px !important;
      border-bottom: 1px solid var(--border);
    }

    .failing-team-row-content {
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      cursor: pointer;
      padding: 2px 8px;
      margin: -2px -8px;
      border-radius: 4px;
      transition: background 0.15s;
    }

    .failing-team-row-content:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .failing-team-row-content::before {
      content: '';
      position: absolute;
      left: -40px;
      top: 50%;
      width: 30px;
      height: 1px;
      background: rgba(251, 113, 133, 0.3);
    }

    .failing-team-row-content::after {
      content: '';
      position: absolute;
      left: -40px;
      top: -14px;
      width: 1px;
      height: calc(50% + 14px);
      background: rgba(251, 113, 133, 0.3);
    }

    /* Last failing team row - shorter vertical line */
    .failing-teams-row:last-of-type .failing-team-row-content::after,
    .failing-teams-row.last-failing .failing-team-row-content::after {
      height: calc(50% + 14px);
    }

    .failing-team-row-content .mini-grade-badge {
      font-size: 11px;
      font-weight: 700;
      width: 22px;
      height: 22px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: rgba(251, 113, 133, 0.18);
      color: var(--critical);
      border: 1px solid rgba(251, 113, 133, 0.3);
    }

    .failing-team-path {
      font-size: 13px;
      color: var(--muted);
    }

    .failing-team-row-content:hover .path-leaf {
      color: var(--critical);
    }

    .failing-team-path .path-separator {
      margin: 0 4px;
      color: rgba(169, 180, 214, 0.4);
    }

    .failing-team-path .path-leaf {
      color: var(--text);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <div class="breadcrumb" id="breadcrumb"></div>
      </div>
      <div class="header-actions">
        <a href="#" id="configLink" class="data-editor-link">⚙️ Scorecard Config</a>
        <a href="data-editor.html" class="data-editor-link">✏️ Data Editor</a>
      </div>
    </div>

    <div id="heroGradeContainer"></div>
    <div id="tableContainer"></div>
  </div>

<script>
  // ========== BUILD ORGANIZATION DATA FROM MOCK DATA ==========
  
  // Load configuration and mock data
  const config = window.ScorecardConfig.loadConfig();
  const mockData = window.MockData.loadMockData();
  const normMethods = window.ScorecardConfig.normMethods;
  const compute = window.ScorecardCompute;
  const OrgTree = window.OrgTree;

  // Build organization tree using unified tree model
  const orgTree = OrgTree.buildOrgTree(
    mockData, 
    window.MockData.organizationHierarchy,
    config,
    normMethods,
    compute,
    window.MockData.rootOwnership
  );

  // Original hardcoded data structure preserved for reference:
  /*
  const organizationData = {
    'Applications': {
      name: 'Applications',
      subTeams: ['Frontend', 'Backend API', 'Mobile Apps', 'Search & Discovery'],
      metrics: {
        slos: { score: 88, trend: [85, 86, 87, 88] },
        vulns: { score: 76, trend: [72, 74, 75, 76] },
        bugs: { score: 81, trend: [78, 79, 80, 81] },
        postmortems: { score: 52, trend: [58, 55, 53, 52] }
      },
      teams: {
        'Frontend': {
          metrics: {
            slos: { score: 95, trend: [92, 93, 94, 95] },
            vulns: { score: 82, trend: [78, 80, 81, 82] },
            bugs: { score: 74, trend: [70, 72, 73, 74] },
            postmortems: { score: 68, trend: [65, 66, 67, 68] }
          }
        },
        'Backend API': {
          metrics: {
            slos: { score: 92, trend: [89, 90, 91, 92] },
            vulns: { score: 58, trend: [55, 56, 57, 58] },
            bugs: { score: 88, trend: [85, 86, 87, 88] },
            postmortems: { score: 45, trend: [42, 43, 44, 45] }
          },
          subTeams: {
            'API Gateway': {
              metrics: {
                slos: { score: 95, trend: [92, 93, 94, 95] },
                vulns: { score: 62, trend: [59, 60, 61, 62] },
                bugs: { score: 89, trend: [86, 87, 88, 89] },
                postmortems: { score: 51, trend: [48, 49, 50, 51] }
              }
            },
            'Auth Service': {
              metrics: {
                slos: { score: 88, trend: [85, 86, 87, 88] },
                vulns: { score: 48, trend: [45, 46, 47, 48] },
                bugs: { score: 85, trend: [82, 83, 84, 85] },
                postmortems: { score: 38, trend: [35, 36, 37, 38] }
              }
            },
            'Payment Service': {
              metrics: {
                slos: { score: 93, trend: [90, 91, 92, 93] },
                vulns: { score: 64, trend: [61, 62, 63, 64] },
                bugs: { score: 90, trend: [87, 88, 89, 90] },
                postmortems: { score: 46, trend: [43, 44, 45, 46] }
              }
            }
          }
        },
        'Mobile Apps': {
          metrics: {
            slos: { score: 85, trend: [82, 83, 84, 85] },
            vulns: { score: 78, trend: [75, 76, 77, 78] },
            bugs: { score: 82, trend: [79, 80, 81, 82] },
            postmortems: { score: 48, trend: [45, 46, 47, 48] }
          }
        },
        'Search & Discovery': {
          metrics: {
            slos: { score: 81, trend: [78, 79, 80, 81] },
            vulns: { score: 86, trend: [83, 84, 85, 86] },
            bugs: { score: 79, trend: [76, 77, 78, 79] },
            postmortems: { score: 62, trend: [59, 60, 61, 62] }
          }
        }
      }
    },
    'Infrastructure': {
      name: 'Infrastructure',
      subTeams: ['Cloud Platform', 'Networking', 'Security', 'Database', 'Observability'],
      metrics: {
        slos: { score: 72, trend: [69, 70, 71, 72] },
        vulns: { score: 68, trend: [65, 66, 67, 68] },
        bugs: { score: 79, trend: [76, 77, 78, 79] },
        postmortems: { score: 58, trend: [55, 56, 57, 58] }
      },
      teams: {
        'Cloud Platform': {
          metrics: {
            slos: { score: 68, trend: [65, 66, 67, 68] },
            vulns: { score: 55, trend: [52, 53, 54, 55] },
            bugs: { score: 72, trend: [69, 70, 71, 72] },
            postmortems: { score: 62, trend: [59, 60, 61, 62] }
          },
          subTeams: {
            'AWS Infrastructure': {
              metrics: {
                slos: { score: 72, trend: [69, 70, 71, 72] },
                vulns: { score: 58, trend: [55, 56, 57, 58] },
                bugs: { score: 75, trend: [72, 73, 74, 75] },
                postmortems: { score: 68, trend: [65, 66, 67, 68] }
              }
            },
            'GCP Infrastructure': {
              metrics: {
                slos: { score: 65, trend: [62, 63, 64, 65] },
                vulns: { score: 51, trend: [48, 49, 50, 51] },
                bugs: { score: 69, trend: [66, 67, 68, 69] },
                postmortems: { score: 58, trend: [55, 56, 57, 58] }
              }
            },
            'Azure Infrastructure': {
              metrics: {
                slos: { score: 67, trend: [64, 65, 66, 67] },
                vulns: { score: 56, trend: [53, 54, 55, 56] },
                bugs: { score: 71, trend: [68, 69, 70, 71] },
                postmortems: { score: 60, trend: [57, 58, 59, 60] }
              }
            }
          }
        },
        'Networking': {
          metrics: {
            slos: { score: 76, trend: [73, 74, 75, 76] },
            vulns: { score: 71, trend: [68, 69, 70, 71] },
            bugs: { score: 83, trend: [80, 81, 82, 83] },
            postmortems: { score: 58, trend: [55, 56, 57, 58] }
          }
        },
        'Security': {
          metrics: {
            slos: { score: 78, trend: [75, 76, 77, 78] },
            vulns: { score: 92, trend: [89, 90, 91, 92] },
            bugs: { score: 85, trend: [82, 83, 84, 85] },
            postmortems: { score: 71, trend: [68, 69, 70, 71] }
          }
        },
        'Database': {
          metrics: {
            slos: { score: 65, trend: [62, 63, 64, 65] },
            vulns: { score: 58, trend: [55, 56, 57, 58] },
            bugs: { score: 74, trend: [71, 72, 73, 74] },
            postmortems: { score: 48, trend: [45, 46, 47, 48] }
          }
        },
        'Observability': {
          metrics: {
            slos: { score: 73, trend: [70, 71, 72, 73] },
            vulns: { score: 64, trend: [61, 62, 63, 64] },
            bugs: { score: 81, trend: [78, 79, 80, 81] },
            postmortems: { score: 52, trend: [49, 50, 51, 52] }
          }
        }
      }
    },
    'Growth': {
      name: 'Growth',
      subTeams: ['Marketing Automation', 'Analytics', 'A/B Testing', 'User Acquisition'],
      metrics: {
        slos: { score: 84, trend: [81, 82, 83, 84] },
        vulns: { score: 62, trend: [59, 60, 61, 62] },
        bugs: { score: 71, trend: [68, 69, 70, 71] },
        postmortems: { score: 66, trend: [63, 64, 65, 66] }
      },
      teams: {
        'Marketing Automation': {
          metrics: {
            slos: { score: 92, trend: [90, 91, 92, 92] },
            vulns: { score: 68, trend: [70, 69, 68, 68] },
            bugs: { score: 75, trend: [73, 74, 75, 75] },
            postmortems: { score: 65, trend: [66, 66, 65, 65] }
          }
        },
        'Analytics': {
          metrics: {
            slos: { score: 96, trend: [94, 95, 96, 96] },
            vulns: { score: 72, trend: [74, 73, 72, 72] },
            bugs: { score: 82, trend: [80, 81, 82, 82] },
            postmortems: { score: 70, trend: [71, 71, 70, 70] }
          }
        },
        'A/B Testing': {
          metrics: {
            slos: { score: 97, trend: [95, 96, 97, 97] },
            vulns: { score: 65, trend: [68, 67, 66, 65] },
            bugs: { score: 78, trend: [76, 77, 78, 78] },
            postmortems: { score: 72, trend: [73, 73, 72, 72] }
          }
        },
        'User Acquisition': {
          metrics: {
            slos: { score: 95, trend: [93, 94, 95, 95] },
            vulns: { score: 70, trend: [72, 71, 70, 70] },
            bugs: { score: 82, trend: [80, 81, 82, 82] },
            postmortems: { score: 68, trend: [69, 69, 68, 68] }
          }
        }
      }
    },
    'Platform': {
      name: 'Platform',
      subTeams: ['API Gateway', 'Authentication', 'Billing', 'Notifications'],
      metrics: {
        slos: { score: 86, trend: [83, 84, 85, 86] },
        vulns: { score: 73, trend: [70, 71, 72, 73] },
        bugs: { score: 68, trend: [65, 66, 67, 68] },
        postmortems: { score: 71, trend: [68, 69, 70, 71] }
      },
      teams: {
        'API Gateway': {
          metrics: {
            slos: { score: 93, trend: [91, 92, 93, 93] },
            vulns: { score: 82, trend: [84, 83, 82, 82] },
            bugs: { score: 68, trend: [70, 69, 68, 68] },
            postmortems: { score: 75, trend: [73, 74, 75, 75] }
          }
        },
        'Authentication': {
          metrics: {
            slos: { score: 98, trend: [96, 97, 98, 98] },
            vulns: { score: 85, trend: [86, 86, 85, 85] },
            bugs: { score: 72, trend: [74, 73, 72, 72] },
            postmortems: { score: 78, trend: [76, 77, 78, 78] }
          }
        },
        'Billing': {
          metrics: {
            slos: { score: 95, trend: [93, 94, 95, 95] },
            vulns: { score: 78, trend: [80, 79, 78, 78] },
            bugs: { score: 65, trend: [67, 66, 65, 65] },
            postmortems: { score: 68, trend: [66, 67, 68, 68] }
          }
        },
        'Notifications': {
          metrics: {
            slos: { score: 94, trend: [92, 93, 94, 94] },
            vulns: { score: 75, trend: [77, 76, 75, 75] },
            bugs: { score: 75, trend: [77, 76, 75, 75] },
            postmortems: { score: 68, trend: [66, 67, 68, 68] }
          }
        }
      }
    },
    'Data Engineering': {
      name: 'Data Engineering',
      subTeams: ['ETL Pipeline', 'Data Warehouse', 'ML Platform', 'Data Quality'],
      metrics: {
        slos: { score: 91, trend: [88, 89, 90, 91] },
        vulns: { score: 84, trend: [81, 82, 83, 84] },
        bugs: { score: 69, trend: [66, 67, 68, 69] },
        postmortems: { score: 43, trend: [40, 41, 42, 43] }
      },
      teams: {
        'ETL Pipeline': {
          metrics: {
            slos: { score: 98, trend: [96, 97, 98, 98] },
            vulns: { score: 95, trend: [94, 95, 95, 95] },
            bugs: { score: 82, trend: [80, 81, 82, 82] },
            postmortems: { score: 45, trend: [49, 47, 46, 45] }
          }
        },
        'Data Warehouse': {
          metrics: {
            slos: { score: 99, trend: [97, 98, 99, 99] },
            vulns: { score: 98, trend: [97, 98, 98, 98] },
            bugs: { score: 78, trend: [76, 77, 78, 78] },
            postmortems: { score: 50, trend: [54, 52, 51, 50] }
          }
        },
        'ML Platform': {
          metrics: {
            slos: { score: 100, trend: [98, 99, 100, 100] },
            vulns: { score: 96, trend: [95, 96, 96, 96] },
            bugs: { score: 85, trend: [83, 84, 85, 85] },
            postmortems: { score: 52, trend: [56, 54, 53, 52] }
          }
        },
        'Data Quality': {
          metrics: {
            slos: { score: 99, trend: [97, 98, 99, 99] },
            vulns: { score: 98, trend: [97, 98, 98, 98] },
            bugs: { score: 75, trend: [73, 74, 75, 75] },
            postmortems: { score: 45, trend: [49, 47, 46, 45] }
          }
        }
      }
    },
    'Mobile': {
      name: 'Mobile',
      subTeams: ['iOS', 'Android', 'React Native', 'Mobile Backend'],
      metrics: {
        slos: { score: 87, trend: [84, 85, 86, 87] },
        vulns: { score: 79, trend: [76, 77, 78, 79] },
        bugs: { score: 64, trend: [61, 62, 63, 64] },
        postmortems: { score: 67, trend: [64, 65, 66, 67] }
      },
      teams: {
        'iOS': {
          metrics: {
            slos: { score: 94, trend: [92, 93, 94, 94] },
            vulns: { score: 95, trend: [96, 96, 95, 95] },
            bugs: { score: 68, trend: [70, 69, 68, 68] },
            postmortems: { score: 72, trend: [70, 71, 72, 72] }
          }
        },
        'Android': {
          metrics: {
            slos: { score: 96, trend: [94, 95, 96, 96] },
            vulns: { score: 92, trend: [93, 93, 92, 92] },
            bugs: { score: 70, trend: [72, 71, 70, 70] },
            postmortems: { score: 68, trend: [66, 67, 68, 68] }
          }
        },
        'React Native': {
          metrics: {
            slos: { score: 93, trend: [91, 92, 93, 93] },
            vulns: { score: 90, trend: [91, 91, 90, 90] },
            bugs: { score: 72, trend: [74, 73, 72, 72] },
            postmortems: { score: 70, trend: [68, 69, 70, 70] }
          }
        },
        'Mobile Backend': {
          metrics: {
            slos: { score: 97, trend: [95, 96, 97, 97] },
            vulns: { score: 95, trend: [96, 96, 95, 95] },
            bugs: { score: 70, trend: [72, 71, 70, 70] },
            postmortems: { score: 70, trend: [68, 69, 70, 70] }
          }
        }
      }
    }
  };
  */

  // ========== STATE MANAGEMENT ==========
  let currentNode = orgTree; // Current node in the tree (starts at root)
  let chartInstances = {};

  // ========== HELPER FUNCTIONS (from shared scorecard-compute.js) ==========
  const getScoreClass = compute.getScoreClass;
  const getLetterGrade = compute.getLetterGrade;
  const getScoreColor = compute.getScoreColor;

  function createSparkline(canvasId, data, score) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
      chartInstances[canvasId].destroy();
    }

    const color = getScoreColor(score);

    chartInstances[canvasId] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Q-3', 'Q-2', 'Q-1', 'Current'],
        datasets: [{
          data: data,
          borderColor: color,
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: [0, 0, 0, 3],
          pointBackgroundColor: color,
          pointBorderColor: color,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        },
        scales: {
          x: { display: false },
          y: { 
            display: false,
            beginAtZero: false,
            grace: '10%'
          }
        },
        elements: {
          line: {
            borderWidth: 2
          }
        }
      }
    });
  }

  function createFullLineChart(canvasId, metrics) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
      chartInstances[canvasId].destroy();
    }

    chartInstances[canvasId] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Q-3', 'Q-2', 'Q-1', 'Current'],
        datasets: [
          {
            label: 'SLOs',
            data: metrics.slos.trend,
            borderColor: '#93c5fd',
            backgroundColor: 'rgba(147, 197, 253, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#93c5fd',
            pointBorderColor: '#93c5fd',
            tension: 0.3
          },
          {
            label: 'Vulns',
            data: metrics.vulns.trend,
            borderColor: '#fb7185',
            backgroundColor: 'rgba(251, 113, 133, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#fb7185',
            pointBorderColor: '#fb7185',
            tension: 0.3
          },
          {
            label: 'Bugs',
            data: metrics.bugs.trend,
            borderColor: '#fde68a',
            backgroundColor: 'rgba(253, 230, 138, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#fde68a',
            pointBorderColor: '#fde68a',
            tension: 0.3
          },
          {
            label: 'Postmortems',
            data: metrics.postmortems.trend,
            borderColor: '#c4b5fd',
            backgroundColor: 'rgba(196, 181, 253, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#c4b5fd',
            pointBorderColor: '#c4b5fd',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: '#e9eefc',
              font: {
                size: 12,
                weight: '600'
              },
              padding: 15,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            enabled: true,
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(17, 25, 53, 0.95)',
            titleColor: '#e9eefc',
            bodyColor: '#e9eefc',
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y;
              }
            }
          }
        },
        scales: {
          x: {
            display: true,
            grid: {
              display: false,
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: '#a9b4d6',
              font: {
                size: 11
              }
            }
          },
          y: {
            display: true,
            min: 0,
            max: 100,
            grid: {
              color: 'rgba(255, 255, 255, 0.05)',
              borderDash: [3, 3]
            },
            ticks: {
              color: '#a9b4d6',
              font: {
                size: 11
              },
              callback: function(value) {
                return value;
              }
            }
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        }
      }
    });
  }

  // Use tree utility functions for average calculations
  const calculateAverageScore = OrgTree.calculateAverageScore;
  const calculateAverageTrend = OrgTree.calculateAverageTrend;

  /**
   * Get failing teams (score < 60) in the subtree of a node
   * @param {OrgNode} node - The node to get failing teams from
   * @returns {Array<OrgNode>} - Array of failing leaf nodes
   */
  function getFailingTeams(node) {
    const leafNodes = OrgTree.getAllLeafNodes(node);
    return leafNodes.filter(leaf => calculateAverageScore(leaf) < 60);
  }

  /**
   * Render a team path as breadcrumb-style HTML including the parent node
   * @param {Array<string>} teamPath - The full path of the failing team
   * @param {OrgNode} parentNode - The parent node being viewed in the table row
   * @returns {string} - HTML with breadcrumb formatting
   */
  function renderFullTeamPath(teamPath, parentNode) {
    // Start with the parent node name, then add path segments below it
    const parentName = parentNode.name;
    const relativePath = teamPath.slice(parentNode.path.length);
    
    // Build full display path: parent name + relative segments
    const fullPath = [parentName, ...relativePath];
    
    if (fullPath.length === 1) {
      return `<span class="path-leaf">${escapeHtml(fullPath[0])}</span>`;
    }
    
    // All parts except last are muted, last is highlighted
    const pathParts = fullPath.slice(0, -1).map(p => escapeHtml(p));
    const leafPart = escapeHtml(fullPath[fullPath.length - 1]);
    
    return `${pathParts.join('<span class="path-separator">›</span>')}<span class="path-separator">›</span><span class="path-leaf">${leafPart}</span>`;
  }

  /**
   * Render failing teams sub-rows, one row per failing team
   * @param {OrgNode} node - The child node in the table
   * @returns {string} - HTML string for the sub-rows (empty if no failing teams or leaf node)
   */
  function renderFailingTeamsSubRows(node) {
    // Leaf nodes have no teams below them
    if (node.isLeaf) {
      return '';
    }
    
    const failingTeams = getFailingTeams(node);
    if (failingTeams.length === 0) {
      return '';
    }
    
    // Build individual rows for each failing team
    return failingTeams.map((team, index) => {
      const fullPath = renderFullTeamPath(team.path, node);
      const teamPathJson = JSON.stringify(team.path);
      const isLast = index === failingTeams.length - 1;
      
      return `
        <tr class="failing-teams-row${isLast ? ' last-failing' : ''}" onclick='navigateTo(${teamPathJson.replace(/'/g, "\\'")})'>
          <td colspan="5">
            <div class="failing-team-row-content">
              <span class="mini-grade-badge">F</span>
              <span class="failing-team-path">${fullPath}</span>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ========== HELPER FUNCTIONS ==========
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Get avatar URL using i.pravatar.cc (photo-realistic faces)
  // The 'u' parameter seeds the image so the same name always gets the same photo
  function getAvatarUrl(name, size = 24) {
    const seed = encodeURIComponent(name);
    return `https://i.pravatar.cc/${size}?u=${seed}`;
  }

  function getConfigUrl() {
    if (currentNode.path.length === 0) {
      return 'index.html';
    }
    const teamParam = encodeURIComponent(JSON.stringify(currentNode.path));
    return `index.html?team=${teamParam}`;
  }

  // Get ownership info for the current node
  function getOwnershipInfo() {
    return OrgTree.getNodeOwnership(currentNode);
  }

  function renderOwnershipPanel(ownership) {
    if (!ownership) return '';
    
    return `
      <div class="hero-ownership-panel">
        <div class="ownership-info">
          <div class="ownership-row">
            <span class="ownership-role">Engineering Manager</span>
            <div class="ownership-name-row">
              <img src="${getAvatarUrl(ownership.engineeringManager)}" alt="" class="owner-avatar">
              <span class="ownership-name">${escapeHtml(ownership.engineeringManager)}</span>
            </div>
          </div>
          <div class="ownership-row">
            <span class="ownership-role">Product Manager</span>
            <div class="ownership-name-row">
              <img src="${getAvatarUrl(ownership.productManager)}" alt="" class="owner-avatar">
              <span class="ownership-name">${escapeHtml(ownership.productManager)}</span>
            </div>
          </div>
          <div class="ownership-row">
            <span class="ownership-role">Reliability DRI</span>
            <div class="ownership-name-row">
              <img src="${getAvatarUrl(ownership.reliabilityDRI)}" alt="" class="owner-avatar">
              <span class="ownership-name">${escapeHtml(ownership.reliabilityDRI)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderMetricBars(metrics) {
    // Get budget allocations from scorecard configuration
    const budgets = {
      slos: config.slo.pointBudget,
      vulns: config.vuln.budget,
      bugs: config.bug.budget,
      postmortems: config.pm.budget
    };

    const metricConfigs = [
      { key: 'slos', name: 'SLOs', dotClass: 'slos' },
      { key: 'vulns', name: 'Vulns', dotClass: 'vulns' },
      { key: 'bugs', name: 'Bugs', dotClass: 'bugs' },
      { key: 'postmortems', name: 'Postmortems', dotClass: 'postmortems' }
    ];

    return metricConfigs.map(cfg => {
      const metric = metrics[cfg.key];
      const score = metric.score;
      const maxBudget = budgets[cfg.key];
      const scoreClass = getScoreClass(score);
      // Calculate contribution: score (0-100) as percentage of this metric's budget
      const contribution = (score / 100) * maxBudget;
      const pct = score;
      
      return `
        <div class="metric-bar-row">
          <div class="metric-bar-header">
            <span class="metric-bar-dot ${cfg.dotClass}"></span>
            <span class="metric-bar-name">${cfg.name}</span>
            <span class="metric-bar-pct ${scoreClass}">${Math.round(pct)}%</span>
          </div>
          <div class="metric-bar-score">${contribution.toFixed(1)} / ${maxBudget}</div>
          <div class="metric-bar-track">
            <div class="metric-bar-fill ${scoreClass}" style="width: ${pct}%;"></div>
          </div>
        </div>
      `;
    }).join('');
  }

  function calculatePriorityWork() {
    // Get all leaf nodes from current node
    const leafNodes = OrgTree.getAllLeafNodes(currentNode);
    
    // Build team label from path
    const buildTeamLabel = (path) => {
      if (path.length === 0) return '';
      return path.join(' › ');
    };
    
    // Convert leaf nodes to format expected by calculateOpportunitiesForTeams
    const teamsToProcess = leafNodes.map(leaf => ({
      data: leaf.rawData,
      label: buildTeamLabel(leaf.path),
      path: leaf.path
    }));
    
    return compute.calculateOpportunitiesForTeams(teamsToProcess, config, normMethods);
  }

  function renderPriorityWork() {
    const opportunities = calculatePriorityWork();
    
    if (opportunities.length === 0) {
      return '<div class="priority-empty">✓ All items at max score!</div>';
    }
    
    return opportunities.map(opp => {
      // Build URL with team path and item ID
      const teamPathParam = opp.teamPath ? encodeURIComponent(JSON.stringify(opp.teamPath)) : '';
      const itemParam = encodeURIComponent(opp.itemId);
      const href = `index.html?team=${teamPathParam}&item=${itemParam}`;
      
      return `
        <a href="${href}" class="priority-item">
          <div class="priority-item-header">
            <span class="priority-item-dot" style="background: ${opp.categoryColor};"></span>
            <span class="priority-item-category">${opp.category}</span>
            <span class="priority-item-opportunity">+${opp.opportunity.toFixed(2)} pts</span>
          </div>
          <div class="priority-item-name">${escapeHtml(opp.name)}</div>
          <div class="priority-item-team">${escapeHtml(opp.team)}</div>
        </a>
      `;
    }).join('');
  }

  // ========== RENDER FUNCTIONS ==========
  function renderBreadcrumb() {
    const breadcrumbEl = document.getElementById('breadcrumb');
    const path = currentNode.path;
    
    if (path.length === 0) {
      breadcrumbEl.innerHTML = '<span class="breadcrumb-current">R&D</span>';
      return;
    }
    
    // Build breadcrumb trail
    let html = '<a href="#" class="breadcrumb-link" onclick="navigateTo([]); return false;">R&D</a>';
    
    // Add each level of the path
    path.forEach((segment, index) => {
      html += '<span class="breadcrumb-separator">›</span>';
      
      const segmentPath = path.slice(0, index + 1);
      const node = OrgTree.getNodeByPath(orgTree, segmentPath);
      const name = node ? node.name : segment;
      
      if (index === path.length - 1) {
        // Current (last) segment
        html += `<span class="breadcrumb-current">${escapeHtml(name)}</span>`;
      } else {
        // Clickable parent segment
        const pathJson = JSON.stringify(segmentPath);
        html += `<a href="#" class="breadcrumb-link" onclick='navigateTo(${pathJson}); return false;'>${escapeHtml(name)}</a>`;
      }
    });
    
    breadcrumbEl.innerHTML = html;
  }

  function renderHeroGrade() {
    const container = document.getElementById('heroGradeContainer');
    const ownership = getOwnershipInfo();
    const avg = calculateAverageScore(currentNode);
    const trend = calculateAverageTrend(currentNode);
    const avgClass = getScoreClass(avg);
    const letterGrade = getLetterGrade(avg);
    const safeId = currentNode.name.replace(/[^a-zA-Z0-9]/g, '-');
    
    // Calculate total budget and earned score from config
    const totalBudget = config.slo.pointBudget + config.vuln.budget + config.bug.budget + config.pm.budget;
    const metrics = currentNode.metrics;
    const earnedScore = 
      (metrics.slos.score / 100) * config.slo.pointBudget +
      (metrics.vulns.score / 100) * config.vuln.budget +
      (metrics.bugs.score / 100) * config.bug.budget +
      (metrics.postmortems.score / 100) * config.pm.budget;
    
    // Always show inline metrics trend chart for consistency
    container.innerHTML = `
      <div class="hero-section-wrapper">
        <div class="hero-section-subteam">
          <div class="hero-left-column">
            <div class="hero-top-row">
              <div class="hero-grade-column">
                <div class="hero-grade-compact">
                  <div class="hero-grade-title">${escapeHtml(currentNode.name)}</div>
                  <div class="hero-grade-badge ${avgClass}">${letterGrade}</div>
                  <div class="grade-tooltip-wrapper">
                    <div class="hero-grade-score">${Math.round(earnedScore)}/${totalBudget}</div>
                    <div class="grade-info-icon">?</div>
                    <div class="grade-tooltip">
                      <div class="grade-tooltip-title">Score to Grade</div>
                      <div class="grade-tooltip-scale">
                        <div class="grade-tooltip-row">
                          <span class="grade-tooltip-letter grade-a">A</span>
                          <span class="grade-tooltip-range">90 – 100</span>
                        </div>
                        <div class="grade-tooltip-row">
                          <span class="grade-tooltip-letter grade-b">B</span>
                          <span class="grade-tooltip-range">80 – 89</span>
                        </div>
                        <div class="grade-tooltip-row">
                          <span class="grade-tooltip-letter grade-c">C</span>
                          <span class="grade-tooltip-range">70 – 79</span>
                        </div>
                        <div class="grade-tooltip-row">
                          <span class="grade-tooltip-letter grade-d">D</span>
                          <span class="grade-tooltip-range">60 – 69</span>
                        </div>
                        <div class="grade-tooltip-row">
                          <span class="grade-tooltip-letter grade-f">F</span>
                          <span class="grade-tooltip-range">0 – 59</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                ${renderOwnershipPanel(ownership)}
              </div>
              <div class="hero-metrics-panel">
                <h3 class="priority-work-title">Scorecard Breakdown</h3>
                <div class="hero-metrics-bars">
                  ${renderMetricBars(currentNode.metrics)}
                </div>
              </div>
            </div>
            <div class="trend-chart-inline">
              <div class="trend-chart-canvas">
                <canvas id="chart-trend-${safeId}"></canvas>
              </div>
            </div>
          </div>
          <div class="priority-work-panel">
            <h3 class="priority-work-title">Top Opportunities</h3>
            <div class="priority-work-items">
              ${renderPriorityWork()}
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Create full trend chart
    setTimeout(() => {
      createFullLineChart(`chart-trend-${safeId}`, currentNode.metrics);
    }, 0);
  }


  function renderTable() {
    // If current node is a leaf, don't render table (hero has all info)
    if (currentNode.isLeaf) {
      document.getElementById('tableContainer').innerHTML = '';
      return;
    }
    
    const children = currentNode.children;
    const childLabel = OrgTree.getChildLevelLabel(currentNode.level);
    
    let html = `
      <div class="scorecard-table">
        <table>
          <thead>
            <tr>
              <th>${childLabel}</th>
              <th>SLOs</th>
              <th>Vulns</th>
              <th>Bugs</th>
              <th>Postmortems</th>
            </tr>
          </thead>
          <tbody>
    `;

    children.forEach(child => {
      const avg = calculateAverageScore(child);
      const avgClass = getScoreClass(avg);
      const letterGrade = getLetterGrade(avg);
      const avgTrend = calculateAverageTrend(child);
      const safeId = child.path.join('-');
      const pathJson = JSON.stringify(child.path);
      const drillIcon = child.isLeaf ? '' : '<span class="drill-down-icon">›</span>';
      
      html += `
        <tr class="clickable" onclick='navigateTo(${pathJson})'>
          <td class="metric-cell">
            <div class="metric-content">
              <div class="group-name" style="text-align: center; margin-bottom: 8px;">
                ${escapeHtml(child.name)}
                ${drillIcon}
              </div>
              <div class="grade-badge ${avgClass}">${letterGrade}</div>
              <div class="sparkline-container">
                <canvas id="chart-${safeId}-grade"></canvas>
              </div>
            </div>
          </td>
          <td class="metric-cell">
            <div class="metric-content">
              <div class="score-badge ${getScoreClass(child.metrics.slos.score)}">${child.metrics.slos.score}</div>
              <div class="sparkline-container">
                <canvas id="chart-${safeId}-slos"></canvas>
              </div>
            </div>
          </td>
          <td class="metric-cell">
            <div class="metric-content">
              <div class="score-badge ${getScoreClass(child.metrics.vulns.score)}">${child.metrics.vulns.score}</div>
              <div class="sparkline-container">
                <canvas id="chart-${safeId}-vulns"></canvas>
              </div>
            </div>
          </td>
          <td class="metric-cell">
            <div class="metric-content">
              <div class="score-badge ${getScoreClass(child.metrics.bugs.score)}">${child.metrics.bugs.score}</div>
              <div class="sparkline-container">
                <canvas id="chart-${safeId}-bugs"></canvas>
              </div>
            </div>
          </td>
          <td class="metric-cell">
            <div class="metric-content">
              <div class="score-badge ${getScoreClass(child.metrics.postmortems.score)}">${child.metrics.postmortems.score}</div>
              <div class="sparkline-container">
                <canvas id="chart-${safeId}-postmortems"></canvas>
              </div>
            </div>
          </td>
        </tr>
        ${renderFailingTeamsSubRows(child)}
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;

    document.getElementById('tableContainer').innerHTML = html;

    // Create sparklines
    setTimeout(() => {
      children.forEach(child => {
        const avg = calculateAverageScore(child);
        const avgTrend = calculateAverageTrend(child);
        const safeId = child.path.join('-');
        createSparkline(`chart-${safeId}-grade`, avgTrend, avg);
        createSparkline(`chart-${safeId}-slos`, child.metrics.slos.trend, child.metrics.slos.score);
        createSparkline(`chart-${safeId}-vulns`, child.metrics.vulns.trend, child.metrics.vulns.score);
        createSparkline(`chart-${safeId}-bugs`, child.metrics.bugs.trend, child.metrics.bugs.score);
        createSparkline(`chart-${safeId}-postmortems`, child.metrics.postmortems.trend, child.metrics.postmortems.score);
      });
    }, 0);
  }

  function updateHeaderButtons() {
    // Update the config link based on current navigation path
    const configLink = document.getElementById('configLink');
    if (configLink) {
      configLink.href = getConfigUrl();
    }
  }

  function render() {
    renderBreadcrumb();
    updateHeaderButtons();
    renderHeroGrade();
    renderTable();
  }

  // ========== NAVIGATION ==========
  // Handle navigation to a path (shared logic for clicks and popstate)
  function handleNavigation(path) {
    const node = OrgTree.getNodeByPath(orgTree, path);
    if (node) {
      currentNode = node;
      render();
    } else {
      // Path not found, go to root
      currentNode = orgTree;
      render();
    }
  }

  function navigateTo(path) {
    const node = OrgTree.getNodeByPath(orgTree, path);
    if (node) {
      currentNode = node;
      // Update URL and localStorage via TeamNavigation
      TeamNavigation.navigateTo(path, null);
      render();
      // Scroll to top to show new content
      window.scrollTo(0, 0);
    }
  }

  // ========== INITIALIZATION ==========
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize team navigation with popstate handling
    const initialPath = TeamNavigation.init(handleNavigation);
    
    // Navigate to initial path (validate it exists in org tree)
    const node = OrgTree.getNodeByPath(orgTree, initialPath);
    if (node) {
      currentNode = node;
    }
    // If path not found, currentNode stays at orgTree root
    
    render();
  });
</script>
</body>
</html>
